generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum FocusStatus {
  in_progress
  completed
  interrupted
}

enum TaskStatus {
  pending
  generating
  uploading
  minting
  completed
  failed
}

model User {
  id                String    @id @default(cuid())
  address           String    @unique
  chainId           Int       @map("chain_id")
  nickname          String?
  avatar            String?
  totalFocusMinutes Int       @default(0) @map("total_focus_minutes")
  totalFlowers      Int       @default(0) @map("total_flowers")
  streakDays        Int       @default(0) @map("streak_days")
  lastFocusDate     DateTime? @map("last_focus_date") @db.Timestamptz
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz

  sessions FocusSession[]
  flowers  Flower[]
  likes    Like[]

  @@map("users")
}

model FocusSession {
  id              String      @id @default(cuid())
  userId          String      @map("user_id")
  reason          String
  durationSeconds Int         @map("duration_seconds")
  startedAt       DateTime    @map("started_at") @db.Timestamptz
  completedAt     DateTime?   @map("completed_at") @db.Timestamptz
  status          FocusStatus @default(in_progress)
  interrupted     Boolean     @default(false)
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz

  user   User    @relation(fields: [userId], references: [id])
  flower Flower?

  @@index([userId, status])
  @@index([userId, startedAt(sort: Desc)])
  @@map("focus_sessions")
}

model Flower {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  sessionId   String   @unique @map("session_id")
  prompt      String?
  imageUrl    String?  @map("image_url")
  metadataUrl String?  @map("metadata_url")
  tokenId     Int?     @map("token_id")
  txHash      String?  @map("tx_hash")
  minted      Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  user    User         @relation(fields: [userId], references: [id])
  session FocusSession @relation(fields: [sessionId], references: [id])
  task    FlowerTask?
  likes   Like[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("flowers")
}

model FlowerTask {
  id          String     @id @default(cuid())
  flowerId    String     @unique @map("flower_id")
  status      TaskStatus @default(pending)
  retryCount  Int        @default(0) @map("retry_count")
  maxRetries  Int        @default(3) @map("max_retries")
  error       String?
  startedAt   DateTime?  @map("started_at") @db.Timestamptz
  completedAt DateTime?  @map("completed_at") @db.Timestamptz
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  flower Flower @relation(fields: [flowerId], references: [id])

  @@index([status])
  @@map("flower_tasks")
}

model Like {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  flowerId  String   @map("flower_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  user   User   @relation(fields: [userId], references: [id])
  flower Flower @relation(fields: [flowerId], references: [id])

  @@unique([userId, flowerId])
  @@index([flowerId])
  @@map("likes")
}
